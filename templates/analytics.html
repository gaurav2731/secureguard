{% extends "base.html" %}

{% block title %}Analytics - SecureGuard Enhanced Firewall{% endblock %}

{% block head %}
<style>
    .analytics-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-container {
        position: relative;
        height: 400px;
        background: var(--secondary-bg);
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        padding: 20px;
        margin: 20px 0;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-text);
        margin: 0;
    }

    .chart-controls {
        display: flex;
        gap: 10px;
    }

    .time-selector {
        background: var(--tertiary-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 12px;
        color: var(--primary-text);
        font-size: 0.9rem;
    }

    .time-selector:focus {
        outline: none;
        border-color: var(--neon-blue);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .stat-card {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        text-align: center;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--neon-blue);
        margin-bottom: 10px;
    }

    .stat-label {
        color: var(--secondary-text);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-change {
        font-size: 0.8rem;
        margin-top: 5px;
    }

    .stat-change.positive {
        color: var(--neon-green);
    }

    .stat-change.negative {
        color: var(--neon-red);
    }

    .attack-types {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .attack-type-item {
        background: var(--tertiary-bg);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .attack-type-name {
        font-weight: 500;
        color: var(--primary-text);
    }

    .attack-type-count {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--neon-orange);
    }

    .top-attackers {
        margin-top: 20px;
    }

    .attacker-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .attacker-item:last-child {
        border-bottom: none;
    }

    .attacker-ip {
        font-family: 'Courier New', monospace;
        font-weight: 500;
        color: var(--primary-text);
    }

    .attacker-stats {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .attacker-count {
        color: var(--neon-red);
        font-weight: bold;
    }

    .attacker-score {
        color: var(--neon-orange);
        font-size: 0.9rem;
    }

    .export-controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-export {
        background: var(--neon-green);
        color: var(--primary-bg);
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition-fast);
    }

    .btn-export:hover {
        background: #00ff88;
        transform: translateY(-1px);
    }

    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--muted-text);
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--neon-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">
                <i class="fas fa-chart-line"></i>
                Analytics & Monitoring
            </h1>
            <div class="status-indicator good">
                <div class="status-dot"></div>
                Analytics Active
            </div>
        </div>
        <div class="card-content">
            <p>Detailed analysis of traffic patterns, threat detection, and system performance metrics.</p>
        </div>
    </div>

    <!-- Key Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ top_attackers | length if top_attackers else 0 }}</div>
            <div class="stat-label">Top Attackers</div>
            <div class="stat-change positive">+12% from last week</div>
        </div>

        <div class="stat-card">
            <div class="stat-value">{{ attack_types | length if attack_types else 0 }}</div>
            <div class="stat-label">Attack Types</div>
            <div class="stat-change negative">-5% from last week</div>
        </div>

        <div class="stat-card">
            <div class="stat-value">{{ traffic_data | length if traffic_data else 0 }}</div>
            <div class="stat-label">Data Points</div>
            <div class="stat-change positive">+8% from last week</div>
        </div>

        <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(traffic_data[0].threats if traffic_data else 0) }}</div>
            <div class="stat-label">Avg Threats/Hour</div>
            <div class="stat-change negative">-15% from last week</div>
        </div>
    </div>

    <!-- Traffic Analysis Chart -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-chart-area"></i>
                Traffic Analysis (Last 24 Hours)
            </h2>
        </div>
        <div class="card-content">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Requests & Threats Over Time</h3>
                    <div class="chart-controls">
                        <select class="time-selector" id="timeRange">
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                </div>
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Attack Types Distribution -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-pie-chart"></i>
                Attack Types Distribution
            </h2>
        </div>
        <div class="card-content">
            <div class="chart-container">
                <canvas id="attackTypesChart"></canvas>
            </div>

            <div class="attack-types">
                {% for attack_type in attack_types %}
                <div class="attack-type-item">
                    <span class="attack-type-name">{{ attack_type.reason | replace('_', ' ') | title }}</span>
                    <span class="attack-type-count">{{ attack_type.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Top Attackers -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-user-secret"></i>
                Top Attackers
            </h2>
            <a href="{{ url_for('control_panel') }}" class="btn">Manage Blocks</a>
        </div>
        <div class="card-content">
            <div class="top-attackers">
                {% for attacker in top_attackers %}
                <div class="attacker-item">
                    <span class="attacker-ip">{{ attacker[0] }}</span>
                    <div class="attacker-stats">
                        <span class="attacker-count">{{ attacker[1] }} attacks</span>
                        <span class="attacker-score">High Risk</span>
                    </div>
                </div>
                {% endfor %}
                {% if not top_attackers %}
                <p>No attacker data available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Export Controls -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-download"></i>
                Export Data
            </h2>
        </div>
        <div class="card-content">
            <p>Export analytics data for external analysis or reporting.</p>
            <div class="export-controls">
                <button class="btn-export" onclick="exportData('csv')">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button class="btn-export" onclick="exportData('json')">
                    <i class="fas fa-file-code"></i> Export JSON
                </button>
                <button class="btn-export" onclick="exportData('pdf')">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Traffic Chart
    const trafficCtx = document.getElementById('trafficChart').getContext('2d');
    const trafficData = JSON.parse('{{ traffic_data | tojson | safe }}');

    if (trafficData && trafficData.length > 0) {
        const trafficChart = new Chart(trafficCtx, {
            type: 'line',
            data: {
                labels: trafficData.map(item => item.hour),
                datasets: [{
                    label: 'Requests',
                    data: trafficData.map(item => item.requests),
                    borderColor: 'var(--neon-blue)',
                    backgroundColor: 'rgba(0, 255, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Threats',
                    data: trafficData.map(item => item.threats),
                    borderColor: 'var(--neon-red)',
                    backgroundColor: 'rgba(255, 0, 64, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: 'var(--primary-text)'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: 'var(--secondary-text)'
                        },
                        grid: {
                            color: 'var(--border-color)'
                        }
                    },
                    y: {
                        ticks: {
                            color: 'var(--secondary-text)'
                        },
                        grid: {
                            color: 'var(--border-color)'
                        }
                    }
                }
            }
        });
    }

    // Attack Types Chart
    const attackTypesCtx = document.getElementById('attackTypesChart').getContext('2d');
    const attackTypesData = JSON.parse('{{ attack_types | tojson | safe }}');

    const attackTypesChart = new Chart(attackTypesCtx, {
        type: 'doughnut',
        data: {
            labels: attackTypesData.map(item => item.reason),
            datasets: [{
                data: attackTypesData.map(item => item.count),
                backgroundColor: [
                    'rgba(255, 0, 64, 0.8)',
                    'rgba(255, 128, 0, 0.8)',
                    'rgba(255, 255, 0, 0.8)',
                    'rgba(0, 255, 0, 0.8)',
                    'rgba(0, 255, 255, 0.8)',
                    'rgba(0, 0, 255, 0.8)',
                    'rgba(128, 0, 255, 0.8)'
                ],
                borderColor: 'var(--secondary-bg)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'var(--primary-text)'
                    }
                }
            }
        }
    });

    // Time range selector
    document.getElementById('timeRange').addEventListener('change', function() {
        // In a real implementation, this would fetch new data
        console.log('Time range changed to:', this.value);
    });
});

function exportData(format) {
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading-spinner"></div> Exporting...';
    btn.disabled = true;

    // Simulate export process
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert(`Data exported as ${format.toUpperCase()}`);
    }, 2000);
}
</script>
{% endblock %}
